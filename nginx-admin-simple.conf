events {
    worker_connections 1024;
}

http {
    upstream backend {
        server tabsur-server:5000;
    }

    server {
        listen 80;
        server_name _;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API endpoints
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeout settings
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Admin interface
        location / {
            return 200 '<!DOCTYPE html><html><head><title>Admin Panel</title><style>body{font-family:Arial;margin:40px;background:#f5f5f5}.container{max-width:800px;margin:0 auto;background:white;padding:30px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}h1{color:#333;text-align:center}.nav{display:flex;gap:20px;margin:20px 0;justify-content:center}.nav a{padding:10px 20px;background:#007bff;color:white;text-decoration:none;border-radius:5px}.card{padding:20px;border:1px solid #ddd;border-radius:5px;margin:20px 0;background:#f9f9f9}.status{padding:10px;border-radius:5px;margin:10px 0}.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.warning{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}</style></head><body><div class="container"><h1>üöÄ Tabsur Admin Panel</h1><div class="nav"><a href="#overview">Overview</a><a href="#system">System</a><a href="#users">Users</a><a href="#api">API</a></div><div id="overview" class="card"><h2>üìä System Overview</h2><div id="server-status" class="status">Checking...</div><div id="db-status" class="status">Checking...</div><button onclick="checkAll()">Refresh All</button></div><div id="system" class="card"><h2>‚öôÔ∏è System Health</h2><div id="system-health" class="status">Loading...</div></div><div id="users" class="card"><h2>üë• User Management</h2><div id="user-stats">Loading...</div></div><div id="api" class="card"><h2>üîå API Endpoints</h2><ul><li><code>/api/system/health</code> - System health</li><li><code>/api/users/:id</code> - User info</li><li><code>/api/meals</code> - Meals</li></ul></div></div><script>function checkAll(){checkServerStatus();checkDBStatus();checkSystemHealth();loadUserStats()}async function checkServerStatus(){try{const r=await fetch("/health");const s=document.getElementById("server-status");if(r.ok){s.textContent="‚úÖ Server running";s.className="status success"}else{s.textContent="‚ùå Server error";s.className="status error"}}catch(e){document.getElementById("server-status").textContent="‚ùå Server unreachable";document.getElementById("server-status").className="status error"}}async function checkDBStatus(){try{const r=await fetch("/api/system/health");const d=await r.json();const s=document.getElementById("db-status");if(d.DB==="connected"){s.textContent="‚úÖ Database connected";s.className="status success"}else if(d.DB==="checking"){s.textContent="‚ö†Ô∏è Database checking";s.className="status warning"}else{s.textContent="‚ùå Database disconnected";s.className="status error"}}catch(e){document.getElementById("db-status").textContent="‚ùå Cannot check DB";document.getElementById("db-status").className="status error"}}async function checkSystemHealth(){try{const r=await fetch("/api/system/health");const d=await r.json();const h=document.getElementById("system-health");h.innerHTML="<strong>System:</strong> Server: "+(d.server?"Running":"Stopped")+", Users: "+(d.users||0)+", Meals: "+(d.mealsCreatedToday||0);h.className="status success"}catch(e){document.getElementById("system-health").textContent="‚ùå Cannot load health";document.getElementById("system-health").className="status error"}}async function loadUserStats(){try{const r=await fetch("/api/users/1");const d=await r.json();const s=document.getElementById("user-stats");if(d&&Object.keys(d).length>0){let h="<strong>User Stats:</strong><br>";for(const[k,v]of Object.entries(d)){h+=k+": "+v+"<br>"}s.innerHTML=h}else{s.textContent="No user data"}catch(e){document.getElementById("user-stats").textContent="‚ùå Cannot load stats"}}document.addEventListener("DOMContentLoaded",checkAll);</script></body></html>';
            add_header Content-Type text/html;
        }
    }
}
