name: Security Scan

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”’ Run TruffleHog (secrets detection)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
        head: ${{ github.event.pull_request.head.sha || 'HEAD' }}
        
    - name: ğŸ›¡ï¸ Run Snyk security scan (conditional)
      if: ${{ secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: âš ï¸ Snyk skipped (no token)
      if: ${{ secrets.SNYK_TOKEN == '' }}
      run: |
        echo "âš ï¸ Snyk security scan skipped - SNYK_TOKEN not configured"
        echo "ğŸ’¡ To enable Snyk scanning, add SNYK_TOKEN to repository secrets"
        echo "ğŸ”— Visit: https://github.com/${{ github.repository }}/settings/secrets/actions"
        
    - name: ğŸ” Run npm audit
      run: |
        echo "ğŸ” Running npm audit for server dependencies..."
        npm audit --audit-level moderate || echo "âš ï¸ Server security vulnerabilities found"
        echo "ğŸ” Running npm audit for client dependencies..."
        cd client && npm audit --audit-level moderate || echo "âš ï¸ Client security vulnerabilities found"
        
    - name: ğŸ³ Scan Docker images
      run: |
        echo "ğŸ³ Docker image security scan would run here"
        echo "ğŸ’¡ Consider using Trivy or Snyk for container scanning"
        echo "ğŸ“‹ No Docker images to scan in this repository"
        
    - name: ğŸ“Š Security report
      run: |
        echo "ğŸ”’ Security scan completed successfully!"
        echo "ğŸ“‹ Check the logs above for any security issues"
        echo "ğŸ›¡ï¸ Snyk scan: ${{ secrets.SNYK_TOKEN != '' && 'âœ… Enabled' || 'âš ï¸ Skipped (no token)' }}"
        echo "ğŸ” npm audit: âœ… Completed"
        echo "ğŸ”’ TruffleHog: âœ… Completed"
        echo "ğŸ³ Docker scan: âš ï¸ Not applicable"
