name: Security Scan

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”’ Run TruffleHog (secrets detection)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
        head: ${{ github.event.pull_request.head.sha || 'HEAD' }}
        
    - name: ğŸ›¡ï¸ Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: ğŸ” Run npm audit
      run: |
        npm audit --audit-level moderate || echo "Security vulnerabilities found"
        cd client && npm audit --audit-level moderate || echo "Client security vulnerabilities found"
        
    - name: ğŸ³ Scan Docker images
      run: |
        echo "Docker image security scan would run here"
        echo "Using tools like Trivy or Snyk for container scanning"
        
    - name: ğŸ“Š Security report
      run: |
        echo "ğŸ”’ Security scan completed"
        echo "ğŸ“‹ Check the logs above for any security issues"
        echo "ğŸ›¡ï¸ Snyk report available in the logs"
        echo "ğŸ” npm audit results above"
