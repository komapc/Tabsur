name: Security Scan

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Checkout code
      uses: actions/checkout@v4
      
    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 🔒 Run TruffleHog (secrets detection)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
        head: ${{ github.event.pull_request.head.sha || 'HEAD' }}
        
    - name: 🛡️ Run Snyk security scan (conditional)
      if: ${{ secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: ⚠️ Snyk skipped (no token)
      if: ${{ secrets.SNYK_TOKEN == '' }}
      run: |
        echo "⚠️ Snyk security scan skipped - SNYK_TOKEN not configured"
        echo "💡 To enable Snyk scanning, add SNYK_TOKEN to repository secrets"
        echo "🔗 Visit: https://github.com/${{ github.repository }}/settings/secrets/actions"
        
    - name: 🔍 Run npm audit
      run: |
        echo "🔍 Running npm audit for server dependencies..."
        npm audit --audit-level moderate || echo "⚠️ Server security vulnerabilities found"
        echo "🔍 Running npm audit for client dependencies..."
        cd client && npm audit --audit-level moderate || echo "⚠️ Client security vulnerabilities found"
        
    - name: 🐳 Scan Docker images
      run: |
        echo "🐳 Docker image security scan would run here"
        echo "💡 Consider using Trivy or Snyk for container scanning"
        echo "📋 No Docker images to scan in this repository"
        
    - name: 📊 Security report
      run: |
        echo "🔒 Security scan completed successfully!"
        echo "📋 Check the logs above for any security issues"
        echo "🛡️ Snyk scan: ${{ secrets.SNYK_TOKEN != '' && '✅ Enabled' || '⚠️ Skipped (no token)' }}"
        echo "🔍 npm audit: ✅ Completed"
        echo "🔒 TruffleHog: ✅ Completed"
        echo "🐳 Docker scan: ⚠️ Not applicable"
