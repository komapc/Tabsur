95a0f94bb43ad90de26bb619c962305b
"use strict";

const DOMPurify = require('isomorphic-dompurify');

/**
 * Recursively sanitize nested objects and arrays
 */
const sanitizeValue = value => {
  if (typeof value === 'string') {
    return DOMPurify.sanitize(value, {
      ALLOWED_TAGS: [],
      // No HTML tags allowed
      ALLOWED_ATTR: [] // No attributes allowed
    });
  } else if (Array.isArray(value)) {
    return value.map(sanitizeValue);
  } else if (value && typeof value === 'object') {
    const sanitized = {};
    for (const [key, val] of Object.entries(value)) {
      sanitized[key] = sanitizeValue(val);
    }
    return sanitized;
  }
  return value;
};

/**
 * Input sanitization middleware
 * Prevents XSS attacks and sanitizes user inputs
 */
const sanitizeInput = (req, res, next) => {
  try {
    // Sanitize body parameters
    if (req.body) {
      req.body = sanitizeValue(req.body);
    }

    // Sanitize query parameters
    if (req.query) {
      req.query = sanitizeValue(req.query);
    }

    // Sanitize URL parameters
    if (req.params) {
      req.params = sanitizeValue(req.params);
    }
    next();
  } catch (error) {
    console.error('Sanitization error:', error);
    res.status(400).json({
      error: 'Invalid input detected',
      message: 'Input contains potentially harmful content'
    });
  }
};

/**
 * Enhanced input validation middleware
 * Validates input length and format
 */
const validateInput = (req, res, next) => {
  try {
    const maxLength = 1000; // Maximum input length
    const maxArrayLength = 100; // Maximum array length

    // Validate body
    if (req.body) {
      for (const [key, value] of Object.entries(req.body)) {
        if (typeof value === 'string' && value.length > maxLength) {
          return res.status(400).json({
            error: 'Input too long',
            message: `${key} exceeds maximum length of ${maxLength} characters`
          });
        }
        if (Array.isArray(value) && value.length > maxArrayLength) {
          return res.status(400).json({
            error: 'Array too large',
            message: `${key} exceeds maximum array size of ${maxArrayLength} items`
          });
        }
      }
    }

    // Validate query parameters
    if (req.query) {
      for (const [key, value] of Object.entries(req.query)) {
        if (typeof value === 'string' && value.length > maxLength) {
          return res.status(400).json({
            error: 'Query parameter too long',
            message: `${key} exceeds maximum length of ${maxLength} characters`
          });
        }
      }
    }
    next();
  } catch (error) {
    console.error('Validation error:', error);
    res.status(400).json({
      error: 'Input validation failed',
      message: 'Invalid input format detected'
    });
  }
};
module.exports = {
  sanitizeInput,
  validateInput
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJET01QdXJpZnkiLCJyZXF1aXJlIiwic2FuaXRpemVWYWx1ZSIsInZhbHVlIiwic2FuaXRpemUiLCJBTExPV0VEX1RBR1MiLCJBTExPV0VEX0FUVFIiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJzYW5pdGl6ZWQiLCJrZXkiLCJ2YWwiLCJPYmplY3QiLCJlbnRyaWVzIiwic2FuaXRpemVJbnB1dCIsInJlcSIsInJlcyIsIm5leHQiLCJib2R5IiwicXVlcnkiLCJwYXJhbXMiLCJlcnJvciIsImNvbnNvbGUiLCJzdGF0dXMiLCJqc29uIiwibWVzc2FnZSIsInZhbGlkYXRlSW5wdXQiLCJtYXhMZW5ndGgiLCJtYXhBcnJheUxlbmd0aCIsImxlbmd0aCIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJzYW5pdGl6YXRpb24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRE9NUHVyaWZ5ID0gcmVxdWlyZSgnaXNvbW9ycGhpYy1kb21wdXJpZnknKTtcblxuLyoqXG4gKiBSZWN1cnNpdmVseSBzYW5pdGl6ZSBuZXN0ZWQgb2JqZWN0cyBhbmQgYXJyYXlzXG4gKi9cbmNvbnN0IHNhbml0aXplVmFsdWUgPSAodmFsdWUpID0+IHtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gRE9NUHVyaWZ5LnNhbml0aXplKHZhbHVlLCB7XG4gICAgICBBTExPV0VEX1RBR1M6IFtdLCAvLyBObyBIVE1MIHRhZ3MgYWxsb3dlZFxuICAgICAgQUxMT1dFRF9BVFRSOiBbXSAgLy8gTm8gYXR0cmlidXRlcyBhbGxvd2VkXG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICByZXR1cm4gdmFsdWUubWFwKHNhbml0aXplVmFsdWUpO1xuICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICBjb25zdCBzYW5pdGl6ZWQgPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgT2JqZWN0LmVudHJpZXModmFsdWUpKSB7XG4gICAgICBzYW5pdGl6ZWRba2V5XSA9IHNhbml0aXplVmFsdWUodmFsKTtcbiAgICB9XG4gICAgcmV0dXJuIHNhbml0aXplZDtcbiAgfVxuICByZXR1cm4gdmFsdWU7XG59O1xuXG4vKipcbiAqIElucHV0IHNhbml0aXphdGlvbiBtaWRkbGV3YXJlXG4gKiBQcmV2ZW50cyBYU1MgYXR0YWNrcyBhbmQgc2FuaXRpemVzIHVzZXIgaW5wdXRzXG4gKi9cbmNvbnN0IHNhbml0aXplSW5wdXQgPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBTYW5pdGl6ZSBib2R5IHBhcmFtZXRlcnNcbiAgICBpZiAocmVxLmJvZHkpIHtcbiAgICAgIHJlcS5ib2R5ID0gc2FuaXRpemVWYWx1ZShyZXEuYm9keSk7XG4gICAgfVxuXG4gICAgLy8gU2FuaXRpemUgcXVlcnkgcGFyYW1ldGVyc1xuICAgIGlmIChyZXEucXVlcnkpIHtcbiAgICAgIHJlcS5xdWVyeSA9IHNhbml0aXplVmFsdWUocmVxLnF1ZXJ5KTtcbiAgICB9XG5cbiAgICAvLyBTYW5pdGl6ZSBVUkwgcGFyYW1ldGVyc1xuICAgIGlmIChyZXEucGFyYW1zKSB7XG4gICAgICByZXEucGFyYW1zID0gc2FuaXRpemVWYWx1ZShyZXEucGFyYW1zKTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignU2FuaXRpemF0aW9uIGVycm9yOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICBlcnJvcjogJ0ludmFsaWQgaW5wdXQgZGV0ZWN0ZWQnLFxuICAgICAgbWVzc2FnZTogJ0lucHV0IGNvbnRhaW5zIHBvdGVudGlhbGx5IGhhcm1mdWwgY29udGVudCdcbiAgICB9KTtcbiAgfVxufTtcblxuLyoqXG4gKiBFbmhhbmNlZCBpbnB1dCB2YWxpZGF0aW9uIG1pZGRsZXdhcmVcbiAqIFZhbGlkYXRlcyBpbnB1dCBsZW5ndGggYW5kIGZvcm1hdFxuICovXG5jb25zdCB2YWxpZGF0ZUlucHV0ID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgbWF4TGVuZ3RoID0gMTAwMDsgLy8gTWF4aW11bSBpbnB1dCBsZW5ndGhcbiAgICBjb25zdCBtYXhBcnJheUxlbmd0aCA9IDEwMDsgLy8gTWF4aW11bSBhcnJheSBsZW5ndGhcblxuICAgIC8vIFZhbGlkYXRlIGJvZHlcbiAgICBpZiAocmVxLmJvZHkpIHtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHJlcS5ib2R5KSkge1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB2YWx1ZS5sZW5ndGggPiBtYXhMZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgZXJyb3I6ICdJbnB1dCB0b28gbG9uZycsXG4gICAgICAgICAgICBtZXNzYWdlOiBgJHtrZXl9IGV4Y2VlZHMgbWF4aW11bSBsZW5ndGggb2YgJHttYXhMZW5ndGh9IGNoYXJhY3RlcnNgXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID4gbWF4QXJyYXlMZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgZXJyb3I6ICdBcnJheSB0b28gbGFyZ2UnLFxuICAgICAgICAgICAgbWVzc2FnZTogYCR7a2V5fSBleGNlZWRzIG1heGltdW0gYXJyYXkgc2l6ZSBvZiAke21heEFycmF5TGVuZ3RofSBpdGVtc2BcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICBpZiAocmVxLnF1ZXJ5KSB7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhyZXEucXVlcnkpKSB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHZhbHVlLmxlbmd0aCA+IG1heExlbmd0aCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICBlcnJvcjogJ1F1ZXJ5IHBhcmFtZXRlciB0b28gbG9uZycsXG4gICAgICAgICAgICBtZXNzYWdlOiBgJHtrZXl9IGV4Y2VlZHMgbWF4aW11bSBsZW5ndGggb2YgJHttYXhMZW5ndGh9IGNoYXJhY3RlcnNgXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignVmFsaWRhdGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgZXJyb3I6ICdJbnB1dCB2YWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICBtZXNzYWdlOiAnSW52YWxpZCBpbnB1dCBmb3JtYXQgZGV0ZWN0ZWQnXG4gICAgfSk7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBzYW5pdGl6ZUlucHV0LFxuICB2YWxpZGF0ZUlucHV0XG59O1xuIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLHNCQUFzQixDQUFDOztBQUVqRDtBQUNBO0FBQ0E7QUFDQSxNQUFNQyxhQUFhLEdBQUlDLEtBQUssSUFBSztFQUMvQixJQUFJLE9BQU9BLEtBQUssS0FBSyxRQUFRLEVBQUU7SUFDN0IsT0FBT0gsU0FBUyxDQUFDSSxRQUFRLENBQUNELEtBQUssRUFBRTtNQUMvQkUsWUFBWSxFQUFFLEVBQUU7TUFBRTtNQUNsQkMsWUFBWSxFQUFFLEVBQUUsQ0FBRTtJQUNwQixDQUFDLENBQUM7RUFD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